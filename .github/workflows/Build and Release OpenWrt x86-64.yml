name: Build and Release OpenWrt x86-64
on: 
  workflow_dispatch:
  schedule:
    - cron: 0 20 * * *
env:
  TZ: Asia/Shanghai
jobs:
  build:
    runs-on: ubuntu-24.04
    outputs:
      repo_url: ${{ steps.download_code.outputs.repo_url }}
      latest_branch: ${{ steps.download_code.outputs.latest_branch }}
      latest_tag: ${{ steps.download_code.outputs.latest_tag }}

    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
        echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
        
    - name: æŸ¥çœ‹IP
      run: |
        curl -4 ipinfo.io
        
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        overprovision-lvm: 'true'
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    - name: æ£€æŸ¥ç¡¬ç›˜ä¿¡æ¯
      run: |
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt update
        sudo apt install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget qemu-utils mkisofs
        
        echo "-------------------------æŸ¥çœ‹å·¥ä½œç›®å½•-------------------------"
        echo "å½“å‰ä½ç½®ï¼š"&& pwd
        echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"&& ls -la
        
    - name: è¿å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: æŸ¥çœ‹å·¥ä½œç›®å½•
      run: |
        echo "å½“å‰ä½ç½®ï¼š"&& pwd
        echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"&& ls -la
        
    - name: ä¸‹è½½OpenWRTåŠå…¶ä»–åŒ…ä»£ç 
      id: download_code
      run: |
        REPO_URL=https://github.com/openwrt/openwrt
        git clone $REPO_URL openwrt
        cd openwrt
        echo æ‰€æœ‰åˆ†æ”¯ï¼š&&git branch -r
        echo æ‰€æœ‰æ ‡ç­¾ï¼š&&git tag
        LATEST_BRANCH=$(git branch -r | sed 's/origin\///'|tail -n1)
        LATEST_TAG=$(git tag | grep -v 'rc'|tail -n1)
        echo å½“å‰æœ€æ–°åˆ†æ”¯ï¼š$LATEST_BRANCH
        echo é€‰æ‹©æœ€æ–°éRCæ ‡ç­¾ï¼š$LATEST_TAG
        git checkout $LATEST_TAG
        rm -rf package/helloworld
        git clone --depth=1 https://github.com/fw876/helloworld.git package/helloworld
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/openwrt/packages.git ../gogogo
        git clone https://github.com/xiaorouji/openwrt-passwall.git package/openwrt-passwall
        git clone https://github.com/xiaorouji/openwrt-passwall-packages ../openwrt-passwall-packages
        sed -i 's/192.168.1.1/10.10.10.100/g' package/base-files/files/bin/config_generate
        sed -i 's/192.168./10.10./g' package/base-files/files/bin/config_generate
        HASH=$(openssl passwd -1 -salt DLXGbdIi ${{ github.repository_owner }})
        sed -i "s|^root:::0:99999:7:::|root:$HASH:0:0:99999:7:::|" package/base-files/files/etc/shadow
        cat package/base-files/files/etc/shadow
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        rm -rf feeds/packages/lang/golang
        cp -r ../gogogo/lang/golang/ feeds/packages/lang/
        cp -r ../openwrt-passwall-packages/geoview/ package/geoview/
        git clone https://github.com/linkease/istore.git ./package/istore
        git clone https://github.com/linkease/nas-packages.git ./package/nas-packages
        git clone https://github.com/linkease/nas-packages-luci.git ./package/nas-packages-luci
        echo "repo_url=${REPO_URL}" >> $GITHUB_OUTPUT
        echo "latest_branch=${LATEST_BRANCH}" >> $GITHUB_OUTPUT
        echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        echo "-------------------------æŸ¥çœ‹å·¥ä½œç›®å½•-------------------------"
        echo "å½“å‰ä½ç½®ï¼š"&& pwd
        echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"&& ls -la
        
    - name: å¤åˆ¶.configæ–‡ä»¶
      run: |
        cd openwrt
        cp ../config/diffconfig .config
        make defconfig
        
    - name: é¢„ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt 
        make download -j$(nproc) || make download -j1 V=s
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ä¿®æ­£ Rust Makefile
      run: |
        cd openwrt
        echo "å°è¯•ä¿®æ­£ Rust Makefile"
        sed -i 's/--set=llvm.download-ci-llvm=true/--set=llvm.download-ci-llvm=false/' ./feeds/packages/lang/rust/Makefile && {
            # ä»…åœ¨ sed æˆåŠŸæ—¶æ‰§è¡Œ
            echo "ç¼–è¯‘ä¿¡æ¯ï¼šä¿®æ”¹MakefileæˆåŠŸï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š"
            cat ./feeds/packages/lang/rust/Makefile
        } || {
            # ä»…åœ¨ sed å¤±è´¥æ—¶æ‰§è¡Œ
            echo "ç¼–è¯‘ä¿¡æ¯ï¼šRust Makefile ä¿®æ”¹å¤±è´¥ï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹"
            # å¤±è´¥æ—¶ä¹Ÿcatï¼Œæœ‰åŠ©äºè°ƒè¯•ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨çš„è¯ï¼‰
            cat ./feeds/packages/lang/rust/Makefile 2>/dev/null
            # åœ¨ç¼–è¯‘è„šæœ¬ä¸­ï¼Œå¤±è´¥æ—¶é€šå¸¸åº”è¯¥é€€å‡º
            # exit 1 
        }
        
    - name: å¼€å§‹ç¼–è¯‘
      run: |
        cd openwrt
        make -j$(nproc) || {
            echo "ç¼–è¯‘ä¿¡æ¯ï¼šå¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make -j1 || {
                echo "ç¼–è¯‘ä¿¡æ¯ï¼šå•çº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå¼€å¯è¯¦ç»†æ—¥å¿—..."
                make -j1 V=s 
            }
        }
       
    - name: ç”ŸæˆQCOW2é•œåƒ
      run: |
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        cd openwrt/bin

        # éå†å¹¶å¤„ç†æ–‡ä»¶
        find . -type f \( -name "*.vmdk.gz" -o -name "*.vmdk" \) | while read -r FILE; do
            if [[ $FILE == *.vmdk.gz ]]; then
                # è§£å‹ .vmdk.gz æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
                echo "è§£å‹æ–‡ä»¶: $FILE"
                TEMP_DIR=$(mktemp -d)
                cp "$FILE" "$TEMP_DIR/"
                gunzip "$TEMP_DIR/$(basename "$FILE")"
                VMDK_FILE="$TEMP_DIR/$(basename "${FILE%.gz}")"

                # è½¬æ¢ä¸º .qcow2 æ–‡ä»¶
                QCOW2_FILE="${FILE%.vmdk.gz}.qcow2"
                echo "è½¬æ¢ $VMDK_FILE ä¸º $QCOW2_FILE"
                qemu-img convert -f vmdk -O qcow2 "$VMDK_FILE" "$QCOW2_FILE"

                # å‹ç¼© .qcow2 æ–‡ä»¶ä¸º .qcow2.gz
                echo "å‹ç¼© $QCOW2_FILE ä¸º ${QCOW2_FILE}.gz"
                gzip "$QCOW2_FILE"

                # åˆ é™¤ä¸´æ—¶è§£å‹çš„ .vmdk æ–‡ä»¶
                echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
                rm -f "$VMDK_FILE"
                rmdir "$TEMP_DIR"

                # è®¡ç®—ç”Ÿæˆçš„ .qcow2.gz æ–‡ä»¶çš„ SHA256 å€¼
                FINAL_FILE="${QCOW2_FILE}.gz"
            else
                # æ–‡ä»¶æ˜¯ .vmdkï¼Œç›´æ¥è½¬æ¢ä¸º .qcow2
                QCOW2_FILE="${FILE%.vmdk}.qcow2"
                echo "è½¬æ¢ $FILE ä¸º $QCOW2_FILE"
                qemu-img convert -f vmdk -O qcow2 "$FILE" "$QCOW2_FILE"

                # è®¡ç®—ç”Ÿæˆçš„ .qcow2 æ–‡ä»¶çš„ SHA256 å€¼
                FINAL_FILE="$QCOW2_FILE"
            fi

            # è¿½åŠ  SHA256 å€¼åˆ° sha256sums æ–‡ä»¶
            echo "è®¡ç®— $FINAL_FILE çš„ SHA256 å€¼å¹¶æ›´æ–°åˆ° sha256sums"
            sha256sum "$FINAL_FILE" >> ./targets/x86/64/sha256sums
        done

        echo "æ‰€æœ‰æ“ä½œå®Œæˆï¼"
        ls -la ./targets/x86/64/
        cat ./targets/x86/64/sha256sums
        
    - name : ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt Bin
        path: openwrt/bin
        
    - name: æ£€æŸ¥ç¡¬ç›˜ä¿¡æ¯
      run: |
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
        
    # - name: å¯åŠ¨SSHè°ƒè¯•
    #   if: ${{ failure() }}
    #   uses: mxschmitt/action-tmate@v3

  release:
    runs-on: ubuntu-24.04
    needs: build
    steps:
    - name: ä¸‹è½½å›ºä»¶
      uses: actions/download-artifact@v4
      with:
        name: OpenWrt Bin
        path: openwrt/bin
    - name: æ‰“åŒ…Binç›®å½•
      run: |
        zip -q -s 2000m -r OpenWRT_Bin_v$(date +"%Y.%m.%d").zip openwrt/bin
        for file in OpenWRT_Bin_v$(date +"%Y.%m.%d").*; do
            echo "File: $file"
            echo "Size: $(du -h "$file" | cut -f1)"  # è¾“å‡ºæ–‡ä»¶å¤§å°
            echo "MD5 checksum: $(md5sum "$file" | awk '{print $1}')"  # è®¡ç®—MD5
            echo "SHA256 checksum: $(sha256sum "$file" | awk '{print $1}')"  # è®¡ç®—SHA256
            echo "-------------------------"
        done
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      run: |
        echo "release_tag=v$(date +"%Y.%m.%d")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "
        ğŸ’» æ¶æ„: x86_64

        ğŸ“‚ æºç : ${{ needs.build.outputs.repo_url }}

        ğŸ”— æ ‡ç­¾: ${{ needs.build.outputs.latest_tag }}

        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")

        ğŸŒ ç®¡ç†åœ°å€: 10.10.10.100

        ğŸ‘¤ ç”¨æˆ·å: root

        ğŸ”’ å¯†ç : @${{ github.repository_owner }} " >> release.txt

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          openwrt/bin/targets/x86/64/*
          openwrt/bin/packages/x86_64/base/*passwall*
          openwrt/bin/packages/x86_64/base/*ssr-plus*
          OpenWRT_Bin*.*
